<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Solarny Kalkulator Kredytowy z Raportami PDF</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://rsms.me/">
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    html { font-family: 'Inter',sans-serif; }
    /* … reszta Twojego CSS bez zmian … */
  </style>
</head>
<body class="bg-[var(--bg-primary)] text-[var(--text-primary)] relative solar-flare-bg">
  <!-- … cały Twój HTML (aside, main itd.) bez zmian … -->

  <script>
  // … cały Twój JS do zarządzania transakcjami, datami, fetchFullRateHistory itd. …

  // Pełny Base64 czcionki Roboto-Regular.ttf (tu skrócone)
  const robotoNormalBase64 = "AAEAAAARAQAABAAQR0RFRg... (TU WSTAW CAŁY BASE64)";

  const generateQuarterlyPdf = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'mm', format: 'a4' });

    // 1) Wczytanie i rejestracja czcionki:
    doc.addFileToVFS("Roboto-Regular.ttf", robotoNormalBase64);
    doc.addFont("Roboto-Regular.ttf", "Roboto", "normal");
    doc.setFont("Roboto", "normal");

    // 2) Przygotowanie danych:
    const year    = parseInt(document.getElementById('calc-quarter-year').value);
    const quarter = parseInt(document.getElementById('calc-quarter').value);
    if (isNaN(year) || isNaN(quarter)) {
      showAlert("Proszę wybrać poprawny kwartał i rok.");
      return;
    }
    const startMonth = (quarter-1)*3;
    const startDate  = new Date(year, startMonth, 1);
    const endDate    = new Date(year, startMonth+3, 0);
    const prevEnd    = new Date(year, startMonth, 0);
    const openingBal = getBalanceOnDate(prevEnd);
    const closingBal = getBalanceOnDate(endDate);
    const txs        = state.transactions.filter(t => {
      const d = new Date(t.date);
      return d>=startDate && d<=endDate;
    });
    const sumOfChg   = txs.reduce((s,t)=>s + (t.type==='increase'?t.amount:-t.amount),0);
    const rateStart  = getEffectiveRateForDate(startDate.toISOString().substr(0,10));
    const rateEnd    = getEffectiveRateForDate(endDate.toISOString().substr(0,10));
    const totalInt   = calculateInterestForPeriod(
      startDate.toISOString().substr(0,10),
      endDate.toISOString().substr(0,10)
    ).totalInterest;

    // 3) Nagłówek:
    const pageW = doc.internal.pageSize.getWidth();
    let y = 20;
    doc.setFontSize(14).setFont("Roboto","normal").text(
      `Kwartalny raport dla pożyczki z dnia 28 listopada 2022`,
      pageW/2, y, {align:'center'}
    );
    y += 8;
    doc.setFontSize(11)
       .text(`Kwartał ${["I","II","III","IV"][quarter-1]} ${year}`, pageW/2, y, {align:'center'});
    y += 12;

    // 4) Lewa kolumna – zobowiązania:
    const margin = 15;
    const col1x  = margin;
    const col1v  = margin+70;
    doc.setFontSize(10).setFont("Roboto","normal")
       .text("Zobowiązania:", col1x, y);
    y += 6;
    doc.setFontSize(9)
       .text("Saldo otwarcia:", col1x, y)
       .text(formatCurrency(openingBal), col1v, y, {align:'right'});
    y += 5;
    doc.text("Saldo zamknięcia:", col1x, y)
       .text(formatCurrency(closingBal), col1v, y, {align:'right'});
    y += 5;
    doc.text("Suma zmian:", col1x, y)
       .text(formatCurrency(sumOfChg), col1v, y, {align:'right'});
    y += 8;
    doc.setFont("Roboto","italic")
       .text("Szczegóły zmian:", col1x, y);
    y += 5;
    doc.setFont("Roboto","normal");
    if (txs.length) {
      txs.forEach(t => {
        doc.text(
          `${t.date} → ${t.type==='increase'?'+':'-'}${formatCurrency(t.amount)}`,
          col1x+3, y
        );
        y += 5;
      });
    } else {
      doc.text("- brak -", col1x+3, y);
      y += 5;
    }

    // 5) Prawa kolumna – oprocentowanie:
    let y2 = 20 + 12;
    const col2x  = pageW/2 + 10;
    const col2v  = pageW - margin;
    doc.setFontSize(10).setFont("Roboto","normal")
       .text("Oprocentowanie:", col2x, y2);
    y2 += 6; doc.setFontSize(9)
       .text("Początek kwartału:", col2x, y2)
       .text(`${rateStart.toFixed(2)}%`, col2v, y2, {align:'right'});
    y2 += 5;
    doc.text("Koniec kwartału:", col2x, y2)
       .text(`${rateEnd.toFixed(2)}%`, col2v, y2, {align:'right'});
    y2 += 12;

    // 6) Stopka: odsetki i zapis pliku
    doc.setFontSize(12).setFont("Roboto","normal")
       .text(
         "Odsetki do zapłaty:",
         margin, Math.max(y, y2) + 15
       )
       .text(
         formatCurrency(totalInt),
         pageW - margin,
         Math.max(y, y2) + 15,
         { align:'right' }
       );

    doc.save(`Raport_Q${quarter}_${year}.pdf`);
  };

  // podpinamy przycisk
  document.getElementById('generate-pdf-btn')
          .addEventListener('click', generateQuarterlyPdf);

  // … reszta init(), eventy itd. …
  </script>
</body>
</html>
